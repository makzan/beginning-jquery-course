<style>
  .profile-pic img {
    border-radius: 50%;
  }
</style>

<div class="login">
  <h2>Existing user</h2>
  <form>
    <p>Email:<br>
    <input type='email' id='email'>
    </p>

    <p>
    Password:<br>
    <input type='password' id='password'>
    </p>

    <p><input type='submit' id='login-button' value='Login'></p>
  </form>


  <p><a href='#reset-password'>Reset Password</a></p>
</div>

<div class="signup default-hidden">
  <h2>Create account (Use the same email to keep all existing chats)</h2>
  <form>
    <p>Email:<br>
    <input type='email' id='new-email'>
    </p>

    <p>
    Password:<br>
    <input type='password' id='new-password'>
    </p>

    <p><input type='submit' id='signup-button' value='Signup'></p>
  </form>

</div>

<div class="profile-info">
  <figure class='profile-pic'>
    <img>
  </figure>
  <p>Youâ€™re logged in as <span class='email'></span>.</p>
  <p>Display Name: <input type='text' id='display-name'></p>
  <p><a href='#logout'>Logout</a></p>
</div>

<script>

  // sign-up
  $('#signup-button').click(function(){
    var email = $('#new-email').val();
    var password = $('#new-password').val();

    if (email !== '' && password !== '') {
      $(this).text("Processing...").attr('disabled', 'true');

      var ref = new Firebase(global.fburl);
      ref.createUser({
        email    : email,
        password : password
      }, function(error, userData) {
        if (error) {
          alert("Error creating user:" + error);
        } else {
          console.log("Successfully created user account with uid:", userData.uid);

          userInfo = {
            displayName: email.split('@')[0],
            email: email,
            uid: userData.uid
          }

          userInfoRef = new Firebase(global.fburl + 'users/' + userData.uid);
          userInfoRef.set(userInfo);

          setUserInfo(userInfo.name, userInfo.email, userInfo.uid)

          ref.authWithPassword({
            email    : email,
            password : password
          }, function(){
            location.reload();
          });
        }
      });
    }

    return false;
  });

  // email and readerEmail
  if (localStorage['readerEmail'] !== undefined) {
    $('#email').val(localStorage['readerEmail']);
  }

  // reset password
  $('[href="#reset-password"]').click(function(){
    var ref = new Firebase(global.fburl);
    ref.resetPassword({
      email : $('#email').val()
    }, function(error) {
      if (error === null) {
        alert("Password reset email sent successfully");
      } else {
        alert("Error sending password reset email:" + error);
      }
    });

    return false;
  });

  // UI display

  if (user !== null) {
    $('.login').hide();
    $('.profile-info').show();
    $('.profile-info').find('.email').text(user.password.email);
    $('.profile-info').find('.profile-pic').find('img').attr('src', user.password.profileImageURL);

    if (userInfo !== undefined) {
      $('.profile-info').find("#display-name").val(userInfo.displayName);
    }

    var userInfoRef = new Firebase(global.fburl + 'users/' + user.uid);
    userInfoRef.on('value', function(snapshot){
      var data = snapshot.val();
      $('.profile-info').find("#display-name").val(data.displayName);
    });


  } else {
    $('.profile-info').hide();
    $('.signup').show();
  }

  // logout
  $('[href="#logout"]').click(function(){
    authRef.unauth();
    location.reload();
    return false;
  });

  // login
  $('#login-button').click(function(){

    $(this).attr('disabled', 'true').val('Processing...');

    authRef.authWithPassword({
      "email": $('#email').val(),
      "password": $('#password').val()
    }, function(error, authData) {
      if (error) {
        console.log("Login Failed!", error);
        alert("Login Failed: " + error);
      } else {
        console.log("Authenticated successfully with payload:", authData);

        var userInfoRef = new Firebase(global.fburl + 'users/' + authData.uid);
        userInfoRef.on('value', function(snapshot){
          var data = snapshot.val();
          setUserInfo(data.displayName, authData.password.email, authData.uid);
        });


        location.reload();
      }
    });

    return false;
  });

  // display name
  $('#display-name').change(function(){
    var user = authRef.getAuth();
    if (user !== null) {
      var userRef = new Firebase(global.fburl + 'users/' + user.uid + '/displayName');
      userRef.set($(this).val());
    }
  });
</script>